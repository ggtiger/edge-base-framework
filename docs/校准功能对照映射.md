# VB Form1 与 React/Electron 校准系统功能对照

> 目的：把 VB WinForms 校准程序（Form1）的「按钮控制维度 / 通信维度」与 React/Electron 实现一一对应，确认哪些功能已经实现，哪些是简化或尚未实现的。

---

## 一、整体结构映射

- **VB 端**
  - 单窗体 `Form1`，集中所有按钮、显示框与 TCP 逻辑。
  - 通信：`SocketSend` + `Timerheart` + `Timer1` + `Timersned` + `Receive`。
  - 状态：`connectrc`, `qsselect1`, `wqselect1`, `qzqbtrc` 等一系列整型/布尔状态位。

- **React/Electron 端**
  - 主视图组件：[Calibration](file:///Users/wanghu/work/study/test26/src/renderer/views/Calibration.tsx)。
  - 侧边栏/中间区组件：
    - 左侧：[LeftSidebar](file:///Users/wanghu/work/study/test26/src/renderer/components/LeftSidebar.tsx)（模式、轮位、联动与状态监控）。
    - 中间：[CenterDisplay](file:///Users/wanghu/work/study/test26/src/renderer/components/CenterDisplay.tsx)（车辆示意与测量值显示、零位/回零/回原点动作）。
    - 右侧：[RightSidebar](file:///Users/wanghu/work/study/test26/src/renderer/components/RightSidebar.tsx)（自由测量、定值测量、步进控制与参数锁定）。
  - 通信与状态：
    - TCP 通信与重连：[useTcpConnection](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useTcpConnection.ts)。
    - 轮位选择与联动：[useWheelSelection](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useWheelSelection.ts)。
    - 校准流程与命令片段 `pls`：[useCalibrationFlow](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useCalibrationFlow.ts)。
    - 协议编码/解码工具：[calibrationProtocol](file:///Users/wanghu/work/study/test26/src/renderer/utils/calibrationProtocol.ts)。

---

## 二、按钮控制维度映射

### 1. 连接与窗体控制

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 打开连接 | `Button_Open_Click`：构造 `SocketSend`，连接 `127.0.0.1:10001`，启动 `Receive` 线程，`connectrc = 1` | 头部「启动测试」按钮 + [ConnectionModal](file:///Users/wanghu/work/study/test26/src/renderer/components/ConnectionModal.tsx)：调用 `useTcpConnection.startTest`，内部通过 `window.electronAPI.setTcpConfig` / `connectTcp` 建立连接 | 功能等价。IP/端口由弹窗录入或从主进程配置中读取 |
| 关闭连接 | `Button_Close_Click`：关闭心跳、关闭 socket 与窗体 | 头部「停止测试」按钮调用 `useTcpConnection.stopTest`，发送断连指令，并重置连接状态 | 仅关闭 TCP，不关闭应用窗体；整体行为与「停止测试」一致 |
| 心跳启停 | `Timerheart.Enabled` 在连接后启动，周期发送 `"S1F1"` | [useTcpConnection](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useTcpConnection.ts) 中 `useEffect`：在 `isTcpConnected && testRunning` 时 `setInterval` 每秒发送 `"S1F1"` | 周期与 VB 一致，挂在 React 的 effect 中 |
| 返回主界面 | `Button7_Click`：`Me.Hide()`，`owner.Show()` | 在整体应用层由 [Dashboard](file:///Users/wanghu/work/study/test26/src/renderer/views/Dashboard.tsx) 导航到 Calibration；暂无「返回」按钮，但可以通过主框架控制 | 导航逻辑由上层路由/状态管理控制，当前视图只负责校准界面 |
| 帮助 | `Button8_Click`：弹出 Help 窗体 | Calibration 头部「帮助」按钮，控制 [HelpModal](file:///Users/wanghu/work/study/test26/src/renderer/components/HelpModal.tsx) 显示多张帮助截图 | 功能等价，UI 形式从 WinForms 窗体变为模态弹窗 |

### 2. 模式选择（前束 / 外倾）

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 前束模式选择 | `qsselect_Click`：切换 `qsselect1`，与 `wqselect1` 互斥，同时调整 QS/WQ 角度文本框背景色 | [LeftSidebar](file:///Users/wanghu/work/study/test26/src/renderer/components/LeftSidebar.tsx) 中「前束 / TOE」按钮，点击时通过 `onSelectMode('QS')` 更新 `flow.mode` | 模式状态存入 `flow.mode`；通过视觉高亮样式显示当前模式 |
| 外倾模式选择 | `wqselect_Click`：同上，控制 `wqselect1` | 同上，使用「外倾 / CAM」按钮，`onSelectMode('WQ')` 更新 `flow.mode` | 与 VB 一样是互斥模式，参数锁定后被禁止修改 |
| 当前模式高亮 | 改变对应角度文本框背景（Window vs WindowText） | 左侧模式按钮样式不同（背景、边框、下划线），中间区/右侧内容根据 `mode` 决定使用前束还是外倾数据 | 样式方案不同，但语义一致：当前模式被高亮显示 |

### 3. 轮位选择与联动

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 单轮选择 | `qzqbt`, `qyqbt`, `qzhbt`, `qyhbt` 点击，切换 `qzqbtrc` 等标志，按钮变为 Lime | [LeftSidebar](file:///Users/wanghu/work/study/test26/src/renderer/components/LeftSidebar.tsx) 四个车轮按钮，调用 `useWheelSelection.toggleWheel` 更新 `selectedWheels.{FL,FR,RL,RR}` | `selectedWheels` 替代 VB 中四个独立变量，选中状态通过蓝色背景+光效高亮 |
| 前桥联动 | `qlinkq_Click`：`qlinkqrc` 标志 + 同时选中/取消 `qzqbtrc`、`qyqbtrc` | 左侧前桥连线按钮 `onLinkFront`，调用 `useWheelSelection.linkFront` 同步更新 FL/FR | 实现等价：一次性选中或取消前桥两个车轮 |
| 后桥联动 | `qlinkh_Click`：`qlinkhrc` 与后桥两个轮位 | 左侧后桥连线按钮 `onLinkRear`，调用 `linkRear` 控制 RL/RR | 等价 |
| 左侧联动 | VB 中通过 `LEFT_Qrc` 与若干控制逻辑区分左右车架 | 左侧竖线按钮 `onLinkLeft`，`linkLeft` 使 FL/RL 同时选中/取消 | React 端没有单独的 `LEFT_Qrc`，但联动效果相同 |
| 右侧联动 | `RIGHT_Qrc` | 右侧竖线按钮 `onLinkRight`，`linkRight` 使 FR/RR 同时选中/取消 | 左右车架以轮位布尔组合表达，没有单独变量 |
| 参数锁定后禁止修改轮位 | `qsetrc = 1` 时禁用所有轮位和联动按钮 | `flow.paramsLocked === true` 时，`LeftSidebar` 收到 `disabled` 为 true，所有轮位和联动按钮均被禁用 | 行为一致 |

### 4. 参数设置 A1–A6 与锁定

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| A1–A6 输入 | `QA1`–`QA6` 文本框 + 屏幕键盘；`TextChanged` 校验小数合法性 | [RightSidebar](file:///Users/wanghu/work/study/test26/src/renderer/components/RightSidebar.tsx) 中「定值测量 / FIXED MEASURE」六个输入框，配合 [NumericKeypad](file:///Users/wanghu/work/study/test26/src/renderer/components/NumericKeypad.tsx) | 都采用只读输入 + 弹出数字键盘方式，防止直接键盘输入异常 |
| A1–A6 范围校验 | `Button23_Click` 中检查所有 A 在 `[-90,90]` 且非空，否则提示 | [useCalibrationFlow](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useCalibrationFlow.ts) 中 `setAndToggleParamsLock` 调用 `validateSetpoints`，确保所有设定点非空且在 `[-90,90]` | 逻辑等价，出错时直接 return，不锁定参数 |
| 参数格式化 | `Format(Val(QAx), "0.00")` | `normalizeAngleText` 把合法数字格式化为两位小数，`setAndToggleParamsLock` 中统一调用 | 实现方式不同，但效果相同：统一保留两位小数 |
| 锁定/解锁 | `qsetrc` 从 0→1 加锁，禁用轮位/联动/A1–A6；再次点击解锁 | 右侧「设置/解锁」按钮调用 `setAndToggleParamsLock`，切换 `paramsLocked`；锁定后 LeftSidebar 收到 `disabled`，RightSidebar 输入也变为只读 | 行为一致：锁定后不允许修改轮位和设定值 |

### 5. 自动步骤控制（startqz / startrv + s1–s6）

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 步骤索引 | `steprc` 0–6，表示当前执行的是 A1–A6 哪一步 | [useCalibrationFlow](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useCalibrationFlow.ts) 中 `step` 0–6 表示当前步骤 | 映射一致 |
| 步骤状态指示 | `s1`–`s6` 背景色：红色为执行中，绿色为完成 | `stepStatus: StepStatus[]`，配合 RightSidebar 中 `inputClassForStep` 控制输入框边框与阴影（running / done / idle） | UI 形式不同，但有 running/done/idle 三态指示 |
| 正向启动 | `startqz_Click`：根据 `steprc` 计算下一步，拼接 `pls = "QS:Angle" + QA?` 或 `WQ:Angle`，启用 `Timersned` | RightSidebar 的「启动正测」按钮触发 `flow.startStep('forward', selectedWheels)`；内部根据当前 `step` 和方向计算下一步，生成 `pls = \`\${mode}:Angle\${sp}\``，并开启发送 (`sendEnabled = true`) | 行为与 VB 一致：每次点击进入下一步，并设置对应目标角度 |
| 反向启动 | `startrv_Click`：根据 `steprc` 回退一步，拼接对应 `pls` | 「启动回测」按钮触发 `flow.startStep('reverse', selectedWheels)`，内部分支为 reverse：`step<=1 ? 1 : step-1` | 支持反向步进，逻辑与 VB 类似 |
| 步骤完成判定 | VB 在 `Receive` 中比较实时角度与目标 A 值，同时 `statusrc=0`，将对应 `sX` 改为绿色，并重新启用 `startqz/startrv` | React 在 [Calibration](file:///Users/wanghu/work/study/test26/src/renderer/views/Calibration.tsx#L68-L101) 的入站处理里：解析报文后，取当前模式与第一个选中轮位，对比 `actual` 与 `target`（数值差 <0.005 或文本相等）且 `statusrc=0` 时调用 `flow.setSendEnabled(false)`；完成状态 `stepStatus` 由 `skipStep` 或 `stopStep` 控制 | 当前实现已经具备「达到目标 + statusrc=0 → 停止继续发送」的能力，但 **尚未自动把该步标记为 done**，done 更多由用户通过跳过/停止控制；若要与 VB 完全一致，可在条件满足时再额外更新 `stepStatus` |
| 下一步/上一步按钮 | VB 提供 `Button16`（下一步）/`Button17`（上一步），在 `Receive` 中根据 `statusrc` 启用/禁用 | React 没有单独的「下一步/上一步」按钮，而是通过再次点击「启动正测/回测」+ `startStep` 内部逻辑来前进/后退；跳过当前步骤使用「跳过」按钮 (`skipStep`) | 交互方式不同，但功能可覆盖；如果要 1:1 复现，可在右栏补充「下一步/上一步」按钮，直接操作 `step` |

### 6. 手动控制与回零/归零

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 自由测量前束 | `Button2_Click`：检查选轮/左右车架/范围/模式后，`pls = "QS:Angle" + TextBox1.Text` 并启用 `Timersned` | RightSidebar - 自由测量区域中「前束°」输入 +「启动」按钮，调用 `flow.startManualToe`；内部 `normalizeAngleText` 后设为 `freeMeasure.toe`，并构造 `pls = "QS:Angle" + value`，`setMode('QS')` 并打开发送 | 逻辑基本等价，React 端自动切换模式为 QS |
| 自由测量外倾 | `Button5_Click`：同上，用 `WQ:Angle` 与 TextBox2 | RightSidebar - 「外倾°」+「启动」按钮，调用 `flow.startManualCamber`，构造 `pls = "WQ:Angle" + value`，`setMode('WQ')` | 等价 |
| 回到 Angle0 | `Button18_Click`：根据当前模式发送 `QS:Angle0` 或 `WQ:Angle0` | CenterDisplay 内部通过 `onAction('angle0')` 触发，最终由 `flow.handleAction('angle0')` 设置 `pls = "\${mode}:Angle0"` 并启用发送 | 操作位置从 VB 按钮移动到中间车身按钮区域，但协议行为一致 |
| 零位归零 ZERO | `Button19_Click`：发送 `QS_ZERO` 或 `WQ_ZERO` | CenterDisplay 中相应按钮触发 `onAction('zero')`，`flow.handleAction('zero')` 生成 `pls = "\${mode}_ZERO"` | 协议命令保持一致 |
| 回 Home | VB 中 `HM` 对应 `mode+"_HM"`；由某按钮触发 | CenterDisplay 中的「HM」类动作通过 `onAction('hm')` 传入 `handleAction('hm')`，生成 `pls = "\${mode}_HM"` | 功能一致 |
| 参数/状态重置 | `Button3_Click`、`Button4_Click`：停止发送、清空 A1–A6、恢复步状态与按钮可用性 | RightSidebar「取消」按钮调用 `flow.resetFlow`：清除 `pls`/设定值/锁定状态/步进状态，停止发送 | VB 还会清空部分 UI 文本，React 端则专注于核心校准状态；可根据需要继续扩展 |

### 7. UI 辅助功能

| 功能 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 传感器状态灯 | 控件 `duizhong` 背景色：`SensorOK` 变绿，`SensorNG` 变红 | `parseInboundData` 中解析 `SensorOK/SensorNG` 为 `sensorOk`；在 LeftSidebar 的「SENSOR: OK/NG/UNKNOWN」卡片上以颜色与图标显示 | 行为等价，UI 更现代 |
| 日志显示 | `ListLog` + `line` 计数，超过 50 行清空 | `useTcpConnection` 中的 `tcpLogs`（最近 100 条 TX/RX/SYS 记录），通过 [TcpLogViewer](file:///Users/wanghu/work/study/test26/src/renderer/components/TcpLogViewer.tsx) 展示 | 行为一致但功能更丰富（方向标记、时间戳等） |
| 心跳灯 | `Heart` 控件颜色，在收/发心跳时切换红/绿 | Footer 中的 LINK 状态灯 + header 中测试按钮脉冲动画 + LeftSidebar 中 Link 状态卡片 | 未做 1:1 的单独心跳灯，但整体连接状态可见性更强 |

---

## 三、通信维度映射

### 1. 命令构造（Relay + pls）

| 维度 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 继电器编码 | `Timer1_Tick` 中计算 `relayrc`：每个轮位 +1/+2/+4/+8，模式 QS 加 16，WQ 加 32 | [computeRelayrc](file:///Users/wanghu/work/study/test26/src/renderer/utils/calibrationProtocol.ts#L20-L33)：同样按照 FL/FR/RL/RR 和模式累加 1/2/4/8/16/32 | 完全等价的位编码 |
| Relay 二进制字符串 | `Convert.ToString(relayrc, 2)` | `relayrc.toString(2)` | 等价 |
| 命令前缀与 `pls` | VB 中在 `Timer1_Tick` 内组装：`CMDSend.Text = "QS:Relay" & bits & pls` 或 `WQ:Relay` | [buildCommand](file:///Users/wanghu/work/study/test26/src/renderer/utils/calibrationProtocol.ts#L35-L44)：`return \`\${mode}:Relay\${relayBinary}\${pls}\`` | 组合方式保持一致，只是封装成工具函数 |
| `pls` 的生成 | 由 `startqz/startrv/Button2/Button5/Button18/Button19` 等按钮设置，如 `"QS:Angle1.23"`、`"QS_ZERO"`、`"WQ:Angle0"` | 由 [useCalibrationFlow](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useCalibrationFlow.ts) 中的 `startStep`、`handleAction`、`startManualToe`、`startManualCamber` 等统一生成 | 所有 VB 中出现的模式命令形式都已覆盖 |

### 2. 周期发送（Timersned）

| 维度 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 发送定时器 | `Timersned_Tick`：把 `CMDSend.Text` 转成 ASCII 发送，写日志 | Calibration 中 `useEffect`：当 `tcp.isTcpConnected && flow.sendEnabled && flow.pls && flow.mode` 时，每 200ms 执行一次 `buildCommand` + `tcp.sendTcpCmd(cmd)` | 角色相当于 VB 的 `Timersned` + `Timer1` 的组合：既负责构造命令，也负责周期发送 |
| 启动时机 | 各按钮在设置 `pls` 后把 `Timersned.Enabled = True` | 对应按钮逻辑在设置好 `pls` 后把 `sendEnabled = true` | 行为一致 |
| 停止时机（ACK） | 若接收到 `QSRECVOK/QS_ZEROOK/...` 等关键字则 `Timersned.Enabled = False` | `parseInboundData` 返回 `isAck` 标志；`handleInboundData` 中如果 `isAck` 为 true 则 `setSendEnabled(false)` | ACK 协议以及停止逻辑保持一致 |
| 停止时机（达到目标角度） | 当 `statusrc=0` 且实际角度与目标 A 值相等时，将当前步设为完成并停止进一步自动操作 | Calibration 中的入站处理在同样条件下调用 `flow.setSendEnabled(false)`，停止继续发送当前命令 | 止发逻辑一致，步骤状态更新略有差异（见上文） |

### 3. 接收与解析（Receive）

| 维度 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 数据接收入口 | `Receive(SocketSend)` 线程循环 `S.Receive(buffer)`，解析字符串 | Electron 主进程接收 TCP 数据，并通过 `window.electronAPI.onTcpData` 事件传入渲染进程；在 `useTcpConnection` 中注册监听并调用 `onDataReceived` 回调 | 架构从 WinForms 直连改为 Electron IPC 转发 |
| 报文解析 | 通过 `InStr` / `Mid` 手工分隔字段，抽取 `statusrc` 与 `qzq/qyq/...` | [parseInboundData](file:///Users/wanghu/work/study/test26/src/renderer/utils/calibrationProtocol.ts#L78-L144)：使用 `indexOf` 和 `slice` 在 TypeScript 中复刻相同的字段解析逻辑 | 字段顺序、分割方式与 VB 保持一致；对 `\0` 做了清理 |
| 传感器状态 | 检测字符串中是否包含 `"SensorNG"` / `"SensorOK"`，更新 `duizhong` 颜色 | `parseInboundData` 填充 `sensorOk: boolean | null`，`useCalibrationFlow` 在 `handleInboundData` 中写入 `sensorOk` 状态，左侧 UI 读取显示 | 行为一致 |
| 状态码 `statusrc` | 从 `"ST_status"` 后到 `qzq` 前提取数字，写入 `statusrc`，驱动按钮与步进状态 | `parseInboundData` 使用正则 `/ST_status\s*([0-9]+)/i` 抽取，写入 `statusrc`；`useCalibrationFlow` 存入 `statusrc`，在 Calibration 中用于判断是否可以认定步骤完成 | 数值语义一致，后续 UI 使用稍有不同（React 端目前主要用来决定是否停止发送） |
| 测量值数组 | `qzq,qyq,qzh,qyh,wzq,wyq,wzh,wyh` 分别被写入各个文本框 | `measurements` 对象包含上述 8 个字段，在 `handleInboundData` 中按解析结果增量更新；`CenterDisplay` 使用这些值显示 8 个测量框 | 与 VB 相同字段集，显示位置更集中与可视化 |

### 4. 连接状态与重试

| 维度 | VB Form1 | React/Electron 实现 | 说明 |
| --- | --- | --- | --- |
| 基础连接标志 | `connectrc`（0/1） | `tcpStatus` 字符串 + `isTcpConnected` 布尔 | React 端状态更细化（Connected/Disconnected/Closed/Error 等） |
| 重连机制 | VB 主要通过按钮重新连接，未实现系统化重试 | [useTcpConnection](file:///Users/wanghu/work/study/test26/src/renderer/hooks/useTcpConnection.ts) 中维护 `retryCount`，在断开或错误时按 1s 间隔自动重试，超过 `MAX_RETRIES` 弹出连接配置弹窗 | React 端比 VB 增强了连接健壮性 |
| 连接状态显示 | 通过标签文本 + `Heart`/其他灯控件展示 | Header 状态文本（`statusText`）、Footer LINK 灯、LeftSidebar System/Link 卡片多处展示；同时记录在 `tcpLogs` 中 | 状态可视化更丰富，覆盖 VB 行为 |

---

## 四、功能覆盖结论

1. **已经等价实现的核心功能**
   - 前束/外倾模式选择（QS/WQ）及相互独占。
   - 四轮选择与前/后/左/右联动逻辑。
   - A1–A6 设定、范围校验与锁定/解锁逻辑。
   - 自动步进（正向/反向）、自由测量（前束/外倾）、回零（Angle0）、归零（ZERO）和回原点（HM）等命令生成与周期发送机制。
   - 继电器位编码（Relayrc）、命令格式、TCP 心跳与 ACK 停发逻辑。
   - 传感器状态、连接状态与测量数值的解析与显示。

2. **实现方式有差异但语义一致的部分**
   - VB 的 `Timersned + Timer1` 合并为 React 中的一个 `useEffect` 周期发送逻辑，并使用 `buildCommand` 封装命令构造。
   - 步骤完成时，VB 通过绿色 `sX` 块和按钮启用状态指示；React 通过 `stepStatus` + 输入框样式 + 自动停止发送来体现完成，done 状态更多由用户的跳过/停止操作触发。
   - 日志、连接状态与心跳在 React 中通过多处可视化组件表达，不再单独依赖某个灯或文本框。

3. **尚未 1:1 复刻或属于扩展的功能**
   - VB 中显式的「下一步/上一步」按钮（`Button16/17`）在 React 中被「启动正测/回测」与「跳过」逻辑间接替代，尚未单独做成两个按钮。
   - VB 的 `LEFT_Qrc` / `RIGHT_Qrc` 作为独立变量未在 React 中显式存在，但对应的「左右联动」通过 `linkLeft/linkRight` 实现了等价效果。
   - VB 的主窗体 `main` 与 `startTest/tempTest` 的切换逻辑在 React/Electron 侧由 Dashboard + 窗体控制统一管理，不在 Calibration 内部直接处理。
   - React 端新增了主题切换、帮助多页图片、主销模拟输入等扩展功能，这些在 VB 原工程中没有直接对应项。

整体结论：**从协议与状态机角度看，React/Electron 校准实现已经覆盖 VB Form1 中的核心校准流程与通信逻辑**，并在连接管理与可视化方面有所增强。若要做到完全 1:1 的交互体验，还可以在右侧补充「下一步 / 上一步」按钮，并在「达到目标 + statusrc=0」时自动把对应 `stepStatus` 标记为 `done`。

