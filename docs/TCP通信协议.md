# TCP 通信协议文档

## 概述

- **端口**：10001
- **编码**：ASCII
- **连接模式**：客户端模式（连接到下位机）

---

## 接收数据帧格式

### 1. 标准数据帧

实时角度数据，包含8个测量值和状态码。

```
_ST_status{状态值}qzq{值}qyq{值}qzh{值}qyh{值}wzq{值}wyq{值}wzh{值}wyh{值}ND
```

| 字段 | 说明 |
|------|------|
| `_ST_status{n}` | 状态码：0=空闲, >0=忙碌 |
| `qzq` | 前束-左前角度 |
| `qyq` | 前束-右前角度 |
| `qzh` | 前束-左后角度 |
| `qyh` | 前束-右后角度 |
| `wzq` | 外倾-左前角度 |
| `wyq` | 外倾-右前角度 |
| `wzh` | 外倾-左后角度 |
| `wyh` | 外倾-右后角度 |
| `ND` | 帧结束标记 |

**示例**：
```
_ST_status0qzq1.50qyq-0.30qzh0.00qyh0.10wzq2.00wyq1.80wzh0.50wyh0.45ND
```

### 2. 传感器状态消息

四个轮位传感器的在位状态。

```
SENSOR,{值1},{值2},{值3},{值4}
```

| 字段 | 说明 |
|------|------|
| 值1 | 左前传感器：1=在位, 0=离位 |
| 值2 | 右前传感器 |
| 值3 | 左后传感器 |
| 值4 | 右后传感器 |

**示例**：
```
SENSOR,1,1,0,1
```

### 3. 回原点状态消息

电机回原点进度状态。

```
HOMING_STATUS,{电机0},{电机1},{电机2},{电机3}
```

| 状态值 | 说明 |
|--------|------|
| 0 | 未动作/待机 |
| 1 | 正在回原点 |
| 2 | 回原点完成 |

**示例**：
```
HOMING_STATUS,2,2,1,0
```

### 4. 回原点超时消息

```
_HOMING_TIMEOUT
```

下位机回原点超时时发送此消息，上位机应中止回原点流程并提示用户。

### 5. 命令执行完成消息

| 消息 | 说明 |
|------|------|
| `QSRECVOK` | 前束命令执行完成 |
| `WQRECVOK` | 外倾命令执行完成 |
| `QS_HMOK` | 前束回零完成 |
| `WQ_HMOK` | 外倾回零完成 |
| `QS_ZEROOK` | 前束置零完成 |
| `WQ_ZEROOK` | 外倾置零完成 |

---

## 发送命令格式

### 1. 角度控制命令

控制电机运动到指定角度。

```
{QS|WQ}:Relay{继电器二进制码}Angle{角度值}
```

| 字段 | 说明 |
|------|------|
| `QS` | 前束模式 |
| `WQ` | 外倾模式 |
| `Relay{n}` | 继电器控制码（二进制） |
| `Angle{x}` | 目标角度（如 `Angle1.50`） |

**继电器码计算**：
```
relayrc = 0
if 左前选中: relayrc += 1
if 右前选中: relayrc += 2
if 左后选中: relayrc += 4
if 右后选中: relayrc += 8
if 前束模式: relayrc += 16
if 外倾模式: relayrc += 32
```

**示例**：
```
QS:Relay10001Angle1.50    // 前束模式，左前轮，目标角度1.50°
WQ:Relay101111Angle-2.00  // 外倾模式，全部轮位，目标角度-2.00°
```

### 2. JOG 点动命令

按步距增量移动电机。

```
{QS|WQ}:Relay{继电器二进制码}JOG{±步距角度}
```

**示例**：
```
QS:Relay10001JOG1.00      // 前束模式，左前轮，正向点动1.00°
WQ:Relay100001JOG-0.50    // 外倾模式，左前轮，负向点动0.50°
```

### 3. 回原点命令

触发所有电机回原点（全局命令，不分模式）。

```
START_HOMING
```

### 4. 状态同步命令

请求下位机发送当前状态。

```
SYNC_STATUS
```

### 5. 归零命令

将当前模式下的角度值归零。

```
{QS|WQ}:Angle0
```

**示例**：
```
QS:Angle0    // 前束归零
WQ:Angle0    // 外倾归零
```

### 6. 零点校准命令

将当前位置设为零点基准。

```
{QS|WQ}_ZERO
```

**示例**：
```
QS_ZERO    // 前束置零
WQ_ZERO    // 外倾置零
```

### 7. 丝杆复位命令

外倾丝杆复位。

```
{QS|WQ}_HM
```

**示例**：
```
WQ_HM    // 外倾丝杆复位
```

---

## 通信时序

### 普通控制流程

```
上位机                     下位机
   |                         |
   |--- 角度控制命令 ------->|
   |                         |
   |<--- 标准数据帧 ---------|  (循环发送)
   |<--- 标准数据帧 ---------|
   |                         |
   |<--- QSRECVOK/WQRECVOK --|  (目标达成)
   |                         |
```

### 回原点流程

```
上位机                     下位机
   |                         |
   |--- START_HOMING ------->|
   |                         |
   |<--- HOMING_STATUS ------|  (循环发送进度)
   |<--- HOMING_STATUS ------|
   |                         |
   |<--- HOMING_STATUS(2,2,2,2) |  (全部完成)
   |                         |
```

### 传感器状态流程

```
上位机                     下位机
   |                         |
   |<--- SENSOR,1,1,1,1 -----|  (传感器状态变化时发送)
   |                         |
```

---

## 错误处理

| 情况 | 处理 |
|------|------|
| 连接断开 | 自动重连（最多10次） |
| 命令超时 | 停止发送，提示用户 |
| 回原点超时 | 收到 `_HOMING_TIMEOUT` 后中止流程 |
| 传感器离位 | UI 显示红色指示灯 |

---

## 版本记录

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-01-17 | 初始版本 |
| 1.1 | 2026-01-17 | 添加传感器状态、回原点、JOG点动功能 |
